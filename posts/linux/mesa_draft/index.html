<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Mesa EGL Draft - Reion's Think</title>
<meta name=viewport content="width=device-width,initial-scale=1"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=author content="StaticMania"><meta name=generator content="Hugo 0.128.2"><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/font-awesome/css/font-awesome.min.css><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;500;600;700" rel=stylesheet><link href=/scss/style.min.css rel=stylesheet><link rel="shortcut icon" href=/images/logo.svg type=image/x-icon><link rel=icon href=/images/logo.svg type=image/x-icon></head><body><nav class="navbar navbar-expand-lg site-navigation"><div class=container><a class=navbar-brand href=/><img src=/images/logo.svg alt=logo>
</a><button class="navbar-toggler collapsed" type=button data-toggle=collapse data-target=#sitenavbar>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button><div class="collapse navbar-collapse" id=sitenavbar><ul class="navbar-nav ml-auto main-nav"><li class=nav-item><a class=nav-link href=/>Home</a></li><li class=nav-item><a class=nav-link href=/posts>Posts</a></li><li class=nav-item><a class=nav-link href=/about>About</a></li></ul></div></div></nav><main><section class="site-blog details"><div class=container><div class="row justify-content-center"><div class=col-lg-8><article class=site-blog-details><p><span>July 7, 2024</span> by <span>Reion</span></p><h2 class=blog-title>Mesa EGL Draft</h2><h1 id=api-入口点>API 入口点</h1><p>src/egl/main/eglapi.c</p><h1 id=平台抽象相关>平台抽象相关</h1><p>(include/EGL/eglplatform.h)
EGL 三剑客，分别是 <strong>EGLNativeDisplayType</strong> (EGL 原生显示类型)、EGLNativePixmapType (原生 Pixmap 类型)、EGLNativeWindowType (原生窗口类型)，用于表示与 EGL 交互的不同对象。</p><ul><li>EGLNativeDisplayType 表示 EGL 与底层显示系统之间的原生显示连接，例如 X11 或 Wayland</li><li>EGLNativePixmapType 表示一个底层图像对象，通常用于离屏渲染或抓取屏幕内容</li><li>EGLNativeWindowType 表示底层窗口对象，通常用于在窗口中进行渲染和显示
这三个类型在 EGL 中非常重要，因为它们提供了一个与窗口系统交互的标准化接口，使得 EGL 可以在不同的平台上工作，并与窗口系统无缝集成。在使用 EGL 进行图形开发时，我们通常需要使用这三个类型来表示与系统交互的不同对象。</li></ul><p>三剑客定义：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#75715e>/* EGL 1.2 types, renamed for consistency in EGL 1.3 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>typedef</span> EGLNativeDisplayType NativeDisplayType;
</span></span><span style=display:flex><span><span style=color:#66d9ef>typedef</span> EGLNativePixmapType  NativePixmapType;
</span></span><span style=display:flex><span><span style=color:#66d9ef>typedef</span> EGLNativeWindowType  NativeWindowType;
</span></span></code></pre></div><p>X11</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#75715e>#elif defined(__unix__) || defined(USE_X11)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* X11 (tentative)  */</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;X11/Xlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;X11/Xutil.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>typedef</span> Display <span style=color:#f92672>*</span>EGLNativeDisplayType;
</span></span><span style=display:flex><span><span style=color:#66d9ef>typedef</span> Pixmap   EGLNativePixmapType;
</span></span><span style=display:flex><span><span style=color:#66d9ef>typedef</span> Window   EGLNativeWindowType;
</span></span></code></pre></div><p>Wayland</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#75715e>#elif defined(WL_EGL_PLATFORM)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> wl_display     <span style=color:#f92672>*</span>EGLNativeDisplayType;
</span></span><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> wl_egl_pixmap  <span style=color:#f92672>*</span>EGLNativePixmapType;    <span style=color:#75715e>// 已被弃用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> wl_egl_window  <span style=color:#f92672>*</span>EGLNativeWindowType;
</span></span></code></pre></div><p>wl_egl_pixmap 弃用原因
Kristian Høgsberg (5):</p><ul><li>gbm: Reject buffers that are not wl_drm buffers in gbm_bo_import()</li><li>gbm: Use the kms dumb ioctls for cursor instead of libkms</li><li>egl/wayland: Update to Wayland 0.99 API</li><li>wayland: Remove 0.85 compatibility #ifdefs</li><li>wayland: Drop support for ill-defined, unused wl_egl_pixmap
<a href=https://gitlab.freedesktop.org/mesa/mesa/-/blob/main/docs/relnotes/9.0.1.rst target=_blank>https://gitlab.freedesktop.org/mesa/mesa/-/blob/main/docs/relnotes/9.0.1.rst</a>
提交详细：https://gitlab.freedesktop.org/mesa/mesa/-/commit/e20a0f14b5fdbff9afa5d0d6ee35de8728f6a200</li></ul><p>GBM(Generic Buffer Manager)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#75715e>#elif defined(__GBM__)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> gbm_device  <span style=color:#f92672>*</span>EGLNativeDisplayType;
</span></span><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> gbm_bo      <span style=color:#f92672>*</span>EGLNativePixmapType;
</span></span><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>void</span>               <span style=color:#f92672>*</span>EGLNativeWindowType;
</span></span></code></pre></div><h2 id=wayland>Wayland</h2><h3 id=wl_display>wl_display</h3><p>wl_display 是一个重要的核心对象，代表了 Wayland 服务器的连接点，充当了 Client 和 Server 之间的通信接口。
wl_display主要有以下几个功能：</p><ol><li>管理连接：wl_display 用于管理 Client 与 Wayland Compositor 的连接，包括连接的建立、维护和关闭等操作</li><li>分配对象：Wayland 协议中定义了各种对象（如 wl_surface、wl_seat 等），Client 需要通过 wl_display 向 Wayland Compositor 请求分配这些对象</li><li>接收事件：wl_display也负责接收服务器发送给客户端的事件，如wl_surface的状态改变、输入设备的状态改变等事件</li><li>多线程支持：wl_display 支持多线程访问，多个线程可以同时与 Compositor 进行通信，从而提高了客户端的并发性能</li></ol><h3 id=wl_egl_window>wl_egl_window</h3><p>wl_egl_window (wayland库中的 egl/wayland-egl-backend.h)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#66d9ef>struct</span> wl_egl_window {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>intptr_t</span> version;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> width;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> height;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> dx;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> dy;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> attached_width;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> attached_height;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>driver_private;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span>resize_callback)(<span style=color:#66d9ef>struct</span> wl_egl_window <span style=color:#f92672>*</span>, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span>destroy_window_callback)(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> wl_surface <span style=color:#f92672>*</span>surface;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><h1 id=debug>Debug</h1><pre tabindex=0><code>#0  0x00007fffe2fb2d30 in eglSwapBuffers () from /lib/x86_64-linux-gnu/libEGL.so.1
#1  0x00007ffff003b217 in QtWaylandClient::QWaylandGLContext::swapBuffers (this=0x5555557f9620, surface=0x5555555a1c70)
    at /home/user/ocean/qtwayland/src/hardwareintegration/client/wayland-egl/qwaylandglcontext.cpp:518
#2  0x00007ffff069ca3e in QSGRenderThread::syncAndRender (this=0x5555557a5630, grabImage=0x0)
    at /home/user/ocean/qtdeclarative/src/quick/scenegraph/qsgthreadedrenderloop.cpp:870
#3  0x00007ffff069d6d7 in QSGRenderThread::run (this=0x5555557a5630) at /home/user/ocean/qtdeclarative/src/quick/scenegraph/qsgthreadedrenderloop.cpp:1043
#4  0x00007ffff6e35271 in QThreadPrivate::start(void*) () from /lib/x86_64-linux-gnu/libQt5Core.so.5
#5  0x00007ffff6758ea7 in start_thread (arg=&lt;optimized out&gt;) at pthread_create.c:477
#6  0x00007ffff69ecdef in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:95
</code></pre><h1 id=wl_drm>wl_drm</h1><p>wl_drm 是 mesa 制定的扩展协议
Chromium 对于 ozone/wayland 的支持是增加了 wl_drm 协议，主要是考虑到并不是所有 Wayland Compositor 都对 zwp_linux_dmabuf 的支持，exo 是支持的 (components / exo / wayland / zwp_linux_dmabuf.cc)
<a href=https://chromium.googlesource.com/chromium/src.git/+/cd3bebdd6b95d6be0393df4017cf7d4c2f251e2b target=_blank>https://chromium.googlesource.com/chromium/src.git/+/cd3bebdd6b95d6be0393df4017cf7d4c2f251e2b</a></p></article></div></div></div></section><section class="site-blog details"><div class=container id=reion_blog_comments><div class="row justify-content-center"></div></div></section><script>const isDarkTheme=document.querySelector("body").classList.contains("theme-dark"),themeName=isDarkTheme?"dark":"light_protanopia",com_script=document.createElement("script");com_script.src="https://giscus.app/client.js",com_script.dataset.repo="reionwong/blog_comments",com_script.dataset.repoId="R_kgDOJrDnMQ",com_script.dataset.category="General",com_script.dataset.categoryId="DIC_kwDOJrDnMc4CW8lY",com_script.dataset.mapping="pathname",com_script.dataset.strict="0",com_script.dataset.reactionsEnabled="1",com_script.dataset.emitMetadata="0",com_script.dataset.inputPosition="bottom",com_script.dataset.theme=themeName,com_script.dataset.lang="en",com_script.dataset.loading="lazy",com_script.crossOrigin="anonymous",com_script.async=!0,document.getElementById("reion_blog_comments").appendChild(com_script)</script></main><footer class=site-footer><div class=container><div class=row><div class="col-lg-3 col-md-6"><div class=site-footer-widget><h5 class=site-footer-widget-title>Contact Info</h5><p class=site-footer-widget-description>reionwong@gmail.com<br><a href=tel:></a><br><a href=mailto:></a></p></div></div><div class="col-lg-2 col-md-6"><div class=site-footer-widget><h5 class=site-footer-widget-title>Sitemap</h5><ul class=site-footer-widget-links><li><a href=/about>About</a></li></ul></div></div><div class="col-lg-2 col-md-6"><div class=site-footer-widget><h5 class=site-footer-widget-title>Related</h5><ul class=site-footer-widget-links><li><a href=https://github.com/reionwong target=_blank>Github</a></li><li><a href=https://twitter.com/reionwong target=_blank>Twitter</a></li></ul></div></div><div class="col-lg-3 col-md-6"><div class=site-footer-widget><h5 class=site-footer-widget-title>Blogroll</h5><ul class=site-footer-widget-links><li><a href=https://felixc.at/ target=_blank>Felix’s Blog</a></li><li><a href=https://blog.han-li.cn/ target=_blank>Han Li’s Blog</a></li><li><a href=https://hiif.ong/ target=_blank>hiifong</a></li></ul></div></div><div class="col-lg-2 col-12"><a href=#top class=site-footer-widget-top><img src=/images/to-top.svg alt=back-to-top><p>To the top</p></a></div><div class=col-12><div class=site-footer-copyright><p>© Copyright 2024 - All Rights Reserved by Reion Wong</p></div></div></div></div></footer><script src=/js/vendor.min.js></script><script src=/js/script.min.js></script></body></html>